---
header-includes:
    - \usepackage{needspace}
title: "Analiza MACD"
author: "Sebastian Kwaśniak"
date: "`r Sys.Date()`"
geometry: margin=2cm
output:
    pdf_document:
        keep_tex: yes
bibliography: bibliography.bib
csl: vancouver.csl
---

```{r setup, include=FALSE}
library(knitr)
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
```

# Wstęp

Wykorzystane dane to notowania historyczne MAK (Makarony Polskie S.A) na GPW,
dane zostały pobrane z serwisu stooq.pl.

## MACD

Przy analizie wykorzystamy następujący kod do wygenerowania wykresów:

```{python, file='analyze.py'}
```

## Analiza

Dla zakresu od 2007 do dnia dzisiejszego, nie jesteśmy w stanie nic wywnioskować z wykresu,
zmniejszmy zatem zakres do 1000 ostatnich dni.

```{python, echo=FALSE}
import analyze
_, _, _ = analyze.analyze()
```

Tutaj już bardziej widzimy kilka ciekawszych miejsc. Przyjrzyjmy się bliżej pierwszej połowie 2022.

```{python, echo=FALSE}
import analyze
_, _, _ = analyze.analyze(start='2022-01-01', end='2022-07-31', plot=True)
```

W okolicy marca MACD w miarę dobrze pokazało kiedy kupić i sprzedać. 
Widzimy także, że sygnał kupna i sprzedaży jest nieco opóźniony, gdyby były trochę wcześniej,
to zyski byłyby znacznie większe.

# Analiza przy automatycznym kupnie
Do automatycznej analizy wykorzystamy prosty kod:

\needspace{30\baselineskip}
```{python, file='buy_sell_alg.py'}
```

Dla zakresu od 2022-01-01 do 2022-07-31 momenty kupna i sprzedaży wyglądają następująco:

```{python, echo=FALSE}
import pandas as pd
import matplotlib.pyplot as plt
import analyze
import buy_sell_alg

starting_capital = 1000

df, macd, signal = analyze.analyze(start='2022-01-01', end='2022-07-31', plot=False)
capital = buy_sell_alg.buy_sell_alg(df, macd, signal, starting_capital)
_, ax1 = plt.subplots(figsize=(14, 7))
ax1.plot(df['Data'], df['Zamkniecie'], label='Closing Price')
ax1.legend()
ax1.scatter(df["Data"], df['Kupno'], color='green', label='Buy', marker='^')
ax1.scatter(df["Data"], df['Sprzedaz'], color='red', label='Sell', marker='v')
capital_do_nothing = (df['Zamkniecie'].iloc[-1]/df['Zamkniecie'].iloc[0])*starting_capital
```

Jeśli zaczynalibyśmy z kapitałem `r py$starting_capital`zł, wtedy nasz kapitał urósłby do:
`r prettyNum(round(py$capital,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`
zł. Tymczasem, gdybyśmy po prostu kupili na samym początku i sprzedali na samym końcu tego okresu,
wtedy mielibyśmy
`r prettyNum(round(py$capital_do_nothing,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`
zł.

```{python, echo=FALSE}
import pandas as pd
import matplotlib.pyplot as plt
import analyze
import buy_sell_alg

starting_quantity = 1000

df, macd, signal = analyze.analyze(plot=False)
capital = buy_sell_alg.buy_sell_alg(df, macd, signal, starting_money=0, starting_quantity=starting_quantity)
df.to_csv("result.csv", index=False)
macd_capital_percentage = 100-(capital*100/(starting_quantity*df['Zamkniecie'][0]))
capital_do_nothing = df['Zamkniecie'].iloc[-1]*starting_quantity

capital_percentage = (capital_do_nothing*100/(starting_quantity*df['Zamkniecie'][0]))-100
df['Pieniedzy'] = df['Pieniedzy'].interpolate()

_, ax1 = plt.subplots(figsize=(14, 7))
ax1.plot(df['Data'], df['Pieniedzy'], label='Pieniędzy', color='green')
ax1.legend()

```

Gdybyśmy zaczęli z `r py$starting_quantity` akcjami na start, to na koniec mielibyśmy
`r prettyNum(round(py$capital,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`
zł, jest to spadek na poziomie
`r prettyNum(round(py$macd_capital_percentage,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`%.
Tymczasem, gdybyśmy po prostu kupili na samym początku i sprzedali na samym końcu tego okresu,
wtedy mielibyśmy
`r prettyNum(round(py$capital_do_nothing,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`
zł, czyli
`r prettyNum(round(py$capital_percentage,2), big.mark = " ", decimal.mark = ",", scientific = FALSE)`% zysku.


# Wnioski

MACD opiera się na błędnej logice, ponieważ jak wyczytamy pochodzenie typowych wartości
short window, long window, oraz signal window, to okaże się, że pochodzą 
z czasów, gdy roboczy tydzień trwał 6 dni[@wiki:MACD]. 
Short window trwa 2 tygodnie robocze (12), long trwa miesiąc (26), a signal półtora tygodnia (9).
Gdyby dostosować do czasów aktualnych, to wartości te powinny być inne, lecz
zalecane jest korzystanie z wartości takich, jak większość osób które grają na giełdzie.

<!--
As the working week used to be 6-days, the period settings of (12, 26, 9) represent 2 weeks, 1 month and one and a half week.
Now when the trading weeks have only 5 days, possibilities of changing the period settings cannot be overruled.
However, it is always better to stick to the period settings which are used by the majority of traders as the
buying and selling decisions based on the standard settings further push the prices in that direction.
    -->
